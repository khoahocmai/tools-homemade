<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>V√≤ng Quay May M·∫Øn</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(145deg, #0b132b, #1c2541);
      color: #fff;
    }

    h1 {
      font-size: 40px;
      color: #fff;
      margin-bottom: 5px;
    }

    p.subtitle {
      color: #9aa4b2;
      margin-bottom: 25px;
    }

    .main {
      display: flex;
      height: calc(100% - 110px);
      width: 100%;
      position: relative;
    }

    /* T·∫¶NG 1: B√°nh xe (z-index: 1) */
    .wheel-section {
      position: fixed;
      top: 110px;
      left: 0;
      width: 100vw;
      height: calc(100vh - 110px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1;
      transition: all 0.4s ease;
    }

    /* T·∫¶NG 2: Panel (z-index: 10) */
    .panel {
      position: fixed;
      top: 110px;
      left: 0;
      width: 400px;
      height: calc(100vh - 110px);
      background: rgba(16, 27, 58, 0.95);
      backdrop-filter: blur(10px);
      padding: 30px 25px;
      border-radius: 0 20px 20px 0;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.4s ease-in-out;
      z-index: 10;
    }

    .panel.hidden {
      transform: translateX(-400px);
      /* v·∫´n gi·ªØ m·ªôt ph·∫ßn panel ƒë·ªÉ n√∫t tr·ªìi ra ngo√†i */
    }

    /* N√∫t toggle */
    .toggle-btn {
      position: fixed;
      top: 20px;
      right: -20px;
      width: 40px;
      height: 40px;
      background: #ffb703;
      color: #0b132b;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      font-size: 30px;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 183, 3, 0.4);
      transition: all 0.3s ease;
      z-index: 50;
      line-height: 40px;
      text-align: center;
    }

    .toggle-btn:hover {
      background: #ffd85e;
    }

    /* Khi panel ƒë√≥ng, di chuy·ªÉn n√∫t ra ngo√†i c√πng b√™n tr√°i */
    .panel.hidden .toggle-btn {
      right: -45px;
      transform: rotate(180deg);
    }

    .panel h2 {
      margin-bottom: 15px;
      font-size: 18px;
      color: #f6d55c;
    }

    .info-text {
      font-size: 13px;
      color: #9aa4b2;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    textarea {
      width: 100%;
      height: 230px;
      background: #1c2541;
      color: #fff;
      border: 1px solid #5bc0be;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      margin-bottom: 15px;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.4);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
    }

    .btn.delete {
      background: #3aafa9;
      color: #0b132b;
      width: 100%;
    }

    .btn.delete:hover {
      background: #59d2cb;
    }

    .item-count {
      font-size: 13px;
      color: #9aa4b2;
      margin-top: 12px;
      text-align: center;
    }

    /* B√°nh xe */
    .wheel-container {
      position: relative;
      width: 750px;
      height: 750px;
      transform: rotate(90deg);
      transform-origin: 50% 50%;
    }

    /* M≈©i t√™n */
    #arrow {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%) rotate(90deg);
      width: 90px;
      height: 70px;
      background: linear-gradient(145deg, #c91818, #ff4040);
      clip-path: polygon(0% 0%, 100% 50%, 0% 100%, 25% 50%);
      z-index: 10;
      filter: drop-shadow(0 3px 4px rgba(0, 0, 0, 0.4));
    }

    canvas {
      width: 750px;
      height: 750px;
      background: #162447;
      border-radius: 50%;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.15);
      cursor: pointer;
      transition: 0.25s;
    }

    canvas:hover {
      transform: scale(1.02);
      box-shadow: 0 0 40px rgba(255, 183, 3, 0.3);
    }

    #spinText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-90deg);
      font-size: 30px;
      font-weight: bold;
      color: #ffb703;
      text-shadow: 0 0 10px rgba(255, 183, 3, 0.7);
      pointer-events: none;
      user-select: none;
      transition: opacity 0.3s ease;
    }

    /* T·∫¶NG 3: Overlay k·∫øt qu·∫£ (z-index: 100) */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 100;
    }

    .overlay.show {
      opacity: 1;
      visibility: visible;
      pointer-events: all;
    }

    .overlay .winner-box {
      background: linear-gradient(145deg, #1c2541, #2a3b5c);
      padding: 50px 70px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 40px rgba(255, 183, 3, 0.4), 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 3px solid #ffb703;
      animation: popIn 0.4s ease-out;
    }

    @keyframes popIn {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .overlay .winner-box h2 {
      font-size: 36px;
      color: #ffb703;
      margin-bottom: 15px;
      text-shadow: 0 0 10px rgba(255, 183, 3, 0.5);
    }

    .overlay .controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .overlay button {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(145deg, #3aafa9, #5bc0be);
      color: #0b132b;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(59, 175, 169, 0.3);
    }

    .overlay button:hover {
      background: linear-gradient(145deg, #59d2cb, #7de3dd);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 175, 169, 0.4);
    }

    .history-box {
      background: rgba(12, 20, 44, 0.6);
      border: 1px solid rgba(91, 192, 190, 0.4);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      max-height: 180px;
      display: flex;
      flex-direction: column;
    }

    .history-header {
      font-size: 14px;
      font-weight: 600;
      color: #f6d55c;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .history-list {
      list-style: none;
      font-size: 13px;
      color: #fff;
      line-height: 1.4;
      max-height: 130px;
      overflow-y: auto;
      padding-right: 6px;
    }

    /* t·ª´ng d√≤ng trong l·ªãch s·ª≠ */
    .history-list li {
      display: flex;
      justify-content: space-between;
      background: rgba(91, 192, 190, 0.08);
      border: 1px solid rgba(91, 192, 190, 0.2);
      border-radius: 6px;
      padding: 6px 8px;
      margin-bottom: 6px;
      font-weight: 500;
      color: #fff;
    }

    .history-list li .round-label {
      color: #9aa4b2;
      font-size: 12px;
      font-weight: normal;
      margin-left: 8px;
    }

    .history-list li.removed {
      opacity: 0.6;
      color: #9aa4b2;
      font-style: italic;
    }

    .badge-removed {
      background: rgba(255, 71, 87, 0.15);
      border: 1px solid rgba(255, 71, 87, 0.5);
      color: #ff6b6b;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      line-height: 1.2;
      align-self: center;
    }
  </style>
</head>

<body>
  <div style="text-align:center; padding-top:20px;">
    <h1>V√≤ng Quay May M·∫Øn</h1>
    <p class="subtitle">Nh·∫≠p c√°c m·ª•c v√† quay ƒë·ªÉ t√¨m ra ng∆∞·ªùi may m·∫Øn üéØ</p>
  </div>

  <div class="main">
    <!-- V√≤ng quay - T·∫¶NG 1 -->
    <div class="wheel-section">
      <div class="wheel-container">
        <div id="arrow"></div>
        <canvas id="wheel" width="750" height="750"></canvas>
        <div id="spinText">üéØ Nh·∫•n ƒë·ªÉ quay!</div>
      </div>
    </div>

    <!-- Panel - T·∫¶NG 2 -->
    <div class="panel" id="sidePanel">
      <div class="toggle-btn" id="toggleBtn">¬´</div>
      <h2>üìù Danh s√°ch m·ª•c</h2>
      <div class="info-text">
        Nh·∫≠p m·ªói m·ª•c tr√™n m·ªôt d√≤ng. V√≤ng quay s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi b·∫°n nh·∫≠p!
      </div>
      <textarea id="inputList"
        placeholder="Nh·∫≠p c√°c m·ª•c (m·ªói d√≤ng m·ªôt m·ª•c):&#10;&#10;V√≠ d·ª•:&#10;Ng∆∞·ªùi 1&#10;Ng∆∞·ªùi 2&#10;Ng∆∞·ªùi 3&#10;Ng∆∞·ªùi 4&#10;Ng∆∞·ªùi 5"></textarea>
      <button class="btn delete" onclick="clearList()">üóëÔ∏è X√≥a danh s√°ch</button>
      <div class="item-count" id="itemCount">Ch∆∞a c√≥ m·ª•c n√†o</div>
      <div class="history-box">
        <div class="history-header">üìú K·∫øt qu·∫£</div>
        <ul id="historyList" class="history-list">
          <!-- s·∫Ω ƒë∆∞·ª£c fill b·∫±ng JS -->
        </ul>
      </div>
    </div>
  </div>

  <!-- Overlay k·∫øt qu·∫£ - T·∫¶NG 3 -->
  <div class="overlay" id="resultOverlay">
    <div class="winner-box">
      <h2 id="winnerName"></h2>
      <div class="controls">
        <button onclick="closeOverlay()">ƒê√≥ng</button>
        <button onclick="deleteWinner()">X√≥a</button>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const inputList = document.getElementById("inputList");
    const itemCount = document.getElementById("itemCount");
    const spinText = document.getElementById("spinText");
    const sidePanel = document.getElementById("sidePanel");
    const toggleBtn = document.getElementById("toggleBtn");
    const resultOverlay = document.getElementById("resultOverlay");
    const winnerName = document.getElementById("winnerName");

    let items = [];
    let startAngle = 0;
    let arc = 0;
    let spinTimeout = null;
    let spinAngleStart = 0;
    let spinTime = 0;
    let spinTimeTotal = 0;
    let isSpinning = false;

    // l·ªãch s·ª≠ c√°c l∆∞·ª£t ƒë√£ "x√°c nh·∫≠n"
    let history = []; // [{ name: "Ng∆∞·ªùi 4", round: 1 }, ...]
    let roundCounter = 0;

    // winner c·ªßa l∆∞·ª£t QUAY G·∫¶N NH·∫§T (ch∆∞a commit v√†o l·ªãch s·ª≠)
    let pendingWinner = null;
    let pendingRecorded = false; // ƒë·ªÉ tr√°nh commit tr√πng

    // Event listeners
    inputList.addEventListener('input', generateWheel);
    window.addEventListener('load', () => {
      inputList.value = "Ng∆∞·ªùi 1\nNg∆∞·ªùi 2\nNg∆∞·ªùi 3\nNg∆∞·ªùi 4\nNg∆∞·ªùi 5";
      generateWheel();
    });

    toggleBtn.addEventListener('click', () => {
      sidePanel.classList.toggle('hidden');
      toggleBtn.textContent = '¬´';
    });

    function clearList() {
      items = [];
      inputList.value = "";
      drawWheel();
      winnerName.textContent = "";
      hideOverlay();
      updateUI();

      // reset lu√¥n l·ªãch s·ª≠ v√† b·ªô ƒë·ªám v√¨ coi nh∆∞ ch∆°i l·∫°i t·ª´ ƒë·∫ßu
      history = [];
      roundCounter = 0;
      pendingWinner = null;
      pendingRecorded = false;
      renderHistory();
    }

    function deleteWinner() {
      // B·∫•m "X√≥a" t·ª©c l√† k·∫øt qu·∫£ n√†y ƒë√£ ch·ªët -> ƒë·∫£m b·∫£o ƒë√£ v√†o history
      commitHistoryIfNeeded();

      if (!pendingWinner) {
        return;
      }

      // X√≥a ng∆∞·ªùi th·∫Øng kh·ªèi danh s√°ch quay hi·ªán t·∫°i
      const idx = items.findIndex(
        i => i.replace(/\s/g, "") === pendingWinner.replace(/\s/g, "")
      );
      if (idx >= 0) {
        items.splice(idx, 1);
        inputList.value = items.join("\n");
        generateWheel();
      }

      // ƒê√°nh d·∫•u entry t∆∞∆°ng ·ª©ng trong history l√† ƒë√£ b·ªã x√≥a kh·ªèi danh s√°ch
      // V√¨ m√¨nh v·ª´a unshift v√†o history trong commitHistoryIfNeeded(),
      // ph·∫ßn t·ª≠ ƒë√≥ s·∫Ω n·∫±m ·ªü history[0]
      if (history.length > 0 && history[0].name === pendingWinner) {
        history[0].removed = true;
        renderHistory();
      }

      // d·ªçn popup + unlock quay
      winnerName.textContent = "";
      hideOverlay();
      isSpinning = false;
      updateUI();

      // clear tr·∫°ng th√°i pending cho l∆∞·ª£t n√†y
      pendingWinner = null;
      pendingRecorded = false;
    }

    function generateWheel() {
      const input = inputList.value.trim();
      items = input.split(/\n+/).map(i => i.trim()).filter(i => i !== "");
      if (items.length === 0) {
        arc = 0;
        drawWheel();
        updateUI();
        return;
      }
      arc = Math.PI * 2 / items.length;
      drawWheel();
      updateUI();
    }

    function updateUI() {
      if (items.length === 0) {
        itemCount.textContent = "Ch∆∞a c√≥ m·ª•c n√†o";
        spinText.textContent = "üìù Nh·∫≠p danh s√°ch tr∆∞·ªõc!";
        spinText.style.opacity = 1;
        canvas.style.cursor = "not-allowed";
      } else if (isSpinning) {
        // ƒëang quay ho·∫∑c ƒëang kh√≥a sau quay (tr∆∞·ªõc khi ƒë√≥ng popup)
        spinText.style.opacity = 0;
        canvas.style.cursor = "not-allowed";
      } else {
        itemCount.textContent = `C√≥ ${items.length} m·ª•c`;
        spinText.textContent = "üéØ Nh·∫•n ƒë·ªÉ quay!";
        spinText.style.opacity = 1;
        canvas.style.cursor = "pointer";
      }
    }

    function drawWheel() {
      const outsideRadius = 350;
      const textRadius = 270;
      const insideRadius = 55;
      ctx.clearRect(0, 0, 750, 750);

      if (items.length === 0) {
        ctx.fillStyle = "#2a3b5c";
        ctx.beginPath();
        ctx.arc(375, 375, outsideRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#9aa4b2";
        ctx.font = "20px Segoe UI";
        ctx.textAlign = "center";
        return;
      }

      const colors = ["#5bc0be", "#3aafa9", "#2b7a78", "#238c8d", "#1a5d60", "#0f4c75"];
      for (let i = 0; i < items.length; i++) {
        const angle = startAngle + i * arc;
        ctx.fillStyle = colors[i % colors.length];
        ctx.beginPath();
        ctx.arc(375, 375, outsideRadius, angle, angle + arc, false);
        ctx.arc(375, 375, insideRadius, angle + arc, angle, true);
        ctx.fill();

        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.save();
        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px Segoe UI";
        ctx.textAlign = "center";
        const textX = 375 + Math.cos(angle + arc / 2) * textRadius;
        const textY = 375 + Math.sin(angle + arc / 2) * textRadius;
        ctx.translate(textX, textY);
        ctx.rotate(angle + arc / 2);
        const text = items[i];
        const displayText = text.length > 15 ? text.substring(0, 15) + "..." : text;
        ctx.fillText(displayText, 0, 0);
        ctx.restore();
      }
    }

    canvas.addEventListener('click', spin);

    function spin() {
      if (items.length === 0 || isSpinning) return;
      isSpinning = true;            // kh√≥a quay
      hideOverlay();                // ·∫©n popup c≈© n·∫øu c√≥
      spinText.style.opacity = 0;   // ·∫©n ch·ªØ
      spinAngleStart = randomFloat(10, 30);
      spinTime = 0;
      spinTimeTotal = randomFloat(4000, 8000);
      rotateWheel();
    }

    function rotateWheel() {
      spinTime += 30;
      if (spinTime >= spinTimeTotal) {
        stopRotateWheel();
        return;
      }
      const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
      startAngle += (spinAngle * Math.PI / 180);
      drawWheel();
      spinTimeout = setTimeout(rotateWheel, 30);
    }

    function stopRotateWheel() {
      clearTimeout(spinTimeout);

      const degrees = startAngle * 180 / Math.PI + 90;
      const arcd = arc * 180 / Math.PI;
      const index = Math.floor((360 - (degrees % 360)) / arcd) % items.length;

      drawWheel();

      // L∆∞u ng∆∞·ªùi th·∫Øng v√†o bi·∫øn t·∫°m, CH∆ØA ƒë∆∞a v√†o history
      pendingWinner = items[index];
      pendingRecorded = false;

      // hi·ªán popup sau 500ms
      setTimeout(() => {
        winnerName.textContent = `üéâ ${pendingWinner} üéâ`;
        showOverlay();
      }, 500);
    }

    function easeOut(t, b, c, d) {
      const ts = (t /= d) * t;
      const tc = ts * t;
      return b + c * (tc + -3 * ts + 3 * t);
    }

    function showOverlay() {
      resultOverlay.classList.add('show');
    }

    function hideOverlay() {
      resultOverlay.classList.remove('show');
    }

    // H√†m n√†y commit pendingWinner v√†o history n·∫øu ch∆∞a commit
    function commitHistoryIfNeeded() {
      if (pendingWinner && !pendingRecorded) {
        roundCounter += 1;
        history.unshift({
          name: pendingWinner,
          round: roundCounter,
          removed: false,
        });
        renderHistory();
        pendingRecorded = true;
      }
    }

    function closeOverlay() {
      commitHistoryIfNeeded();

      hideOverlay();
      isSpinning = false;
      updateUI();
    }

    function renderHistory() {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";

      history.forEach(h => {
        const li = document.createElement("li");

        if (h.removed) {
          li.classList.add("removed");
        }

        li.innerHTML = `
      <span>
        ${h.name}
        ${h.removed
            ? `<span class="badge-removed">B·ªã kick sau khi tr√∫ng</span>`
            : ""}
      </span>
      <span class="round-label">L∆∞·ª£t ${h.round}</span>
    `;

        historyList.appendChild(li);
      });
    }

    function randomFloat(min, max) {
      const array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return min + (array[0] / 0xFFFFFFFF) * (max - min);
    }

  </script>

</body>

</html>