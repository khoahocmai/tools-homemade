<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather App</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500&family=Oxygen+Mono&display=swap"
    rel="stylesheet" />

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    crossorigin="anonymous" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .city-title {
      font-size: 2rem;
      font-weight: 600;
    }

    .temp-title {
      font-size: 4rem;
      font-weight: bold;
      color: #333;
    }

    .todays-info {
      text-align: left;
    }

    .week-forecast .col {
      background: rgba(255, 255, 255, 0.85);
      margin: 5px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      cursor: pointer;
    }

    .week-forecast .col:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-3px);
      transition: all 0.2s;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 14px;
      color: #333;
    }

    .measurements {
      display: inline-block;
      margin-top: 10px;
      font-size: 14px;
    }

    .measurements a {
      cursor: pointer;
      font-weight: bold;
    }

    .search-form {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #search-form button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background-color: #4caf50;
      color: #fff;
      margin-left: 5px;
      cursor: pointer;
    }

    #search-form button:hover {
      background-color: #45a049;
    }

    .modal-body table {
      font-size: 14px;
    }
  </style>
</head>

<body>
  <main>
    <!-- search bar and city name -->
    <section class="container">
      <div class="row">
        <form class="col" id="search-form">
          <input type="text" id="search-input" placeholder="Search city..." class="search-form" autocomplete="off" />
          <button type="submit">Search</button>
        </form>
        <h1 class="col d-flex justify-content-center align-items-center city-title" id="searched-city">
          ...
        </h1>
      </div>
      <span class="measurements">
        <a id="celcius-link">C¬∞</a> |
        <a id="fahrenheit-link">F¬∞</a>
      </span>
    </section>

    <!-- temp and day info -->
    <section class="current-weather">
      <div class="container">
        <div class="row">
          <h1 class="col temp-title" id="current-temperature">--¬∞</h1>
          <div class="col todays-info">
            <p id="live-clock">--:--:--</p>
            <h2 id="current-day">--</h2>
            <p id="weather-type">--</p>
          </div>
          <div class="col d-flex align-items-center side-info">
            <ul>
              <li>Humidity: <span id="humidity">--</span></li>
              <li>Wind: <span id="wind">--</span></li>
            </ul>
          </div>
        </div>
      </div>
      <hr />
    </section>

    <!--5 day forecast-->
    <section class="container">
      <div class="row week-forecast" id="forecast-row">
        <!-- forecast cards render b·∫±ng JS -->
      </div>
    </section>

    <footer>
      <p>
        Designed by ƒê·ªó D∆∞∆°ng ƒêƒÉng Khoa ‚úåüèº
      </p>
    </footer>
  </main>

  <!-- Modal chi ti·∫øt -->
  <div class="modal fade" id="forecastModal" tabindex="-1" role="dialog" aria-labelledby="forecastModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="forecastModalLabel">Chi ti·∫øt d·ª± b√°o</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="forecast-modal-body">
          <!-- JS s·∫Ω render -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script>
    const WEATHER_API_KEY = "3f40d381342d444faae94519252609";
    const GEO_API_KEY = "dc69ac2ea84f443dbf397fb0cff3683d";

    let currentData = null;
    let currentUnit = "C";
    let lastCity = "H·ªì Ch√≠ Minh";
    let cityTimeZone = null;

    async function getLatLon(city) {
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(city)}&key=${GEO_API_KEY}`;
      const res = await axios.get(url);
      if (res.data.results.length === 0) throw new Error("Kh√¥ng t√¨m th·∫•y th√†nh ph·ªë");
      return res.data.results[0].geometry;
    }

    function renderWeather(data) {
      currentData = data;

      // City
      document.getElementById("searched-city").textContent =
        `${data.location.name}, ${data.location.country}`;

      // Date & time
      const now = new Date(data.location.localtime);

      document.getElementById("current-day").textContent = "Today";

      // Humidity & Wind
      document.getElementById("humidity").textContent = `${data.current.humidity}%`;
      document.getElementById("wind").textContent = `${data.current.wind_kph} km/h`;

      // Weather type
      document.getElementById("weather-type").textContent = data.current.condition.text;

      // T√≠nh offset so v·ªõi UTC t·ª´ API
      cityTimeZone = data.location.tz_id;

      // Render theo ƒë∆°n v·ªã hi·ªán t·∫°i
      updateTemperatures();
    }

    function updateTemperatures() {
      if (!currentData) return;

      if (currentUnit === "C") {
        document.getElementById("current-temperature").textContent =
          `${currentData.current.temp_c}¬∞C`;
      } else {
        document.getElementById("current-temperature").textContent =
          `${currentData.current.temp_f}¬∞F`;
      }

      // Forecast
      const forecastRow = document.getElementById("forecast-row");
      forecastRow.innerHTML = "";
      currentData.forecast.forecastday.forEach((day, idx) => {
        const dateObj = new Date(day.date);
        const dateLabel = dateObj.toLocaleDateString("vi-VN", {
          weekday: "short",
          day: "2-digit",
          month: "2-digit"
        });
        const avgTemp = currentUnit === "C" ? day.day.avgtemp_c + "¬∞C" : day.day.avgtemp_f + "¬∞F";
        forecastRow.innerHTML += `
          <div class="col forecast-card" data-idx="${idx}">
            <h3>${dateLabel}</h3>
            <br><img src="https:${day.day.condition.icon}" /><br>
            <p class="weather">${day.day.condition.text}</p>
            <span>${avgTemp}</span>
          </div>
        `;
      });

      // add click event
      document.querySelectorAll(".forecast-card").forEach(card => {
        card.addEventListener("click", () => {
          const idx = card.getAttribute("data-idx");
          showForecastDetail(currentData.forecast.forecastday[idx]);
        });
      });
    }

    function showForecastDetail(day) {
      const modalBody = document.getElementById("forecast-modal-body");

      const minTemp = currentUnit === "C" ? day.day.mintemp_c + "¬∞C" : day.day.mintemp_f + "¬∞F";
      const maxTemp = currentUnit === "C" ? day.day.maxtemp_c + "¬∞C" : day.day.maxtemp_f + "¬∞F";

      let hourlyRows = "";
      day.hour.forEach(h => {
        const timeLabel = new Date(h.time).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
        hourlyRows += `
          <tr>
            <td>${timeLabel}</td>
            <td><img src="https:${h.condition.icon}" width="30"></td>
            <td>${currentUnit === "C" ? h.temp_c + "¬∞C" : h.temp_f + "¬∞F"}</td>
            <td>${h.condition.text}</td>
            <td>${h.chance_of_rain}%</td>
            <td>${h.humidity}%</td>
          </tr>
        `;
      });

      modalBody.innerHTML = `
  <div class="card shadow-sm mb-3 border-0">
    <div class="card-body text-center">
      <h5 class="mb-1 fw-bold">${day.date}</h5>
      <p class="text-muted mb-2">${day.day.condition.text}</p>
      <img src="https:${day.day.condition.icon}" alt="weather" width="60" class="mb-2">
      <p class="mb-1">
        <span class="fw-bold text-primary">${minTemp} - ${maxTemp}</span>
      </p>
    </div>
  </div>

  <div class="card shadow-sm mb-3 border-0">
    <div class="card-body">
      <h6 class="fw-bold">Th√¥ng tin trong ng√†y</h6>
      <ul class="list-unstyled mb-0">
        <li><i class="bi bi-thermometer-half me-2"></i>Nhi·ªát ƒë·ªô: ${minTemp} - ${maxTemp}</li>
        <li><i class="bi bi-droplet me-2"></i>ƒê·ªô ·∫©m trung b√¨nh: ${day.day.avghumidity}%</li>
        <li><i class="bi bi-cloud-rain me-2"></i>Kh·∫£ nƒÉng m∆∞a: ${day.day.daily_chance_of_rain}%</li>
        <li><i class="bi bi-sun me-2"></i>UV: ${day.day.uv}</li>
        <li><i class="bi bi-brightness-alt-high me-2"></i>M·∫∑t tr·ªùi m·ªçc: ${day.astro.sunrise}, L·∫∑n: ${day.astro.sunset}</li>
      </ul>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h6 class="fw-bold">D·ª± b√°o theo gi·ªù</h6>
      <div style="max-height:300px; overflow-y:auto;">
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light sticky-top">
            <tr>
              <th>Gi·ªù</th>
              <th></th>
              <th>Nhi·ªát ƒë·ªô</th>
              <th>T√¨nh tr·∫°ng</th>
              <th>% M∆∞a</th>
              <th>ƒê·ªô ·∫©m</th>
            </tr>
          </thead>
          <tbody>
            ${hourlyRows}
          </tbody>
        </table>
      </div>
    </div>
  </div>
`;

      $("#forecastModal").modal("show");
    }

    async function fetchWeather(city) {
      try {
        lastCity = city;
        const { lat, lng } = await getLatLon(city);
        const url = `https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${lat},${lng}&days=5&lang=vi`;
        const res = await axios.get(url);
        renderWeather(res.data);
      } catch (err) {
        alert("L·ªói l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt!");
        console.error(err);
      }
    }

    // Form submit
    document.getElementById("search-form").addEventListener("submit", e => {
      e.preventDefault();
      const city = document.getElementById("search-input").value;
      if (city) fetchWeather(city);
    });

    // Chuy·ªÉn ƒë·ªïi ƒë∆°n v·ªã
    document.getElementById("celcius-link").addEventListener("click", e => {
      e.preventDefault();
      currentUnit = "C";
      updateTemperatures();
    });

    document.getElementById("fahrenheit-link").addEventListener("click", e => {
      e.preventDefault();
      currentUnit = "F";
      updateTemperatures();
    });

    setInterval(() => {
      if (lastCity) {
        fetchWeather(lastCity);
      }
    }, 60000);

    setInterval(() => {
      if (!cityTimeZone) return;

      const cityNow = new Date();

      // Gi·ªù ƒë·ªãa ph∆∞∆°ng theo time zone
      document.getElementById("live-clock").textContent =
        new Intl.DateTimeFormat("vi-VN", {
          timeZone: cityTimeZone,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        }).format(cityNow);

      // Ng√†y ƒë·ªãa ph∆∞∆°ng theo time zone
      document.getElementById("current-day").textContent =
        new Intl.DateTimeFormat("vi-VN", {
          timeZone: cityTimeZone,
          weekday: "long",
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        }).format(cityNow);
    }, 1000);

    fetchWeather("H·ªì Ch√≠ Minh");
  </script>
</body>

</html>